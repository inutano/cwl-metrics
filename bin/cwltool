#!/bin/bash
# cwl-metrics cwltool: a wrapper for cwltool to collect metadata
#
set -e

ARGS=${@}

add_opt(){
  local opt=${1}
  if [[ -z $(echo "${ARGS}" | grep -- "${opt}" ||:) ]]; then
    ARGS="${opt} ${ARGS}"
  fi
}

# Analyze arguments
if [[ $# -eq 0 ]]; then
  cwltool
else
  required_opts="--debug --leave-container --timestamps --compute-checksum --record-container-id"
  for o in ${required_opts}; do
    add_opt "${o}"
  done

  while [[ $# -gt 0 ]]; do
    key=${1}
    case ${key} in
      --outdir)
        OUTDIR="${2}"
        shift
        ;;
      --cidfile-dir)
        CIDDIR="${2}"
        shift
        ;;
    esac
    shift
  done

  if [[ -z "${OUTDIR}" ]]; then
    OUTDIR=$(pwd)
  fi
  ARGS="--outdir ${OUTDIR} ${ARGS}"

  if [[ -z "${CIDDIR}" ]]; then
    CIDDIR=${OUTDIR}
  fi
  ARGS="--cidfile-dir ${CIDDIR} ${ARGS}"

  cwltool ${ARGS} 2> >(tee -a ${OUTDIR}/cwltool.log)
fi
