#!/bin/bash
#
# cwl-metrics
#   usage:
#     cwl-metrics [start|stop|list] <options>
#
set -e

#
# Variables
#
VERSION="20180514"
CWL_METRICS_DIR="${HOME}/.cwlmetrics"

#
# Load functions
#

## Version
version() {
  echo "cwl-metrics version ${VERSION}"
}

## Help
help() {
  cat <<-HELP

cwl-metrics version ${VERSION}
Usage: cwl-metrics [command] [options...]
Commands:
  start    Run CWL-metrics daemon and containers
  stop     Stop daemon and containers
  status   Show CWL-metrics system status
  list     List metrics data stored in Elasticsearch

HELP
}

## Install/Initialize CWL-metrics
check_cmd() {
  cmd=${1}
  printf "Checking ${cmd}..."
  if [[ -e $(which ${cmd}) ]]; then
    echo "OK."
  else
    echo -e "\nERROR: ${cmd} not found."
    echo "Failed to init CWL-metrics"
    exit 1
  fi
}

check_dependencies() {
  check_cmd "git"
  check_cmd "curl"
  check_cmd "perl"
  check_cmd "docker"
  check_cmd "docker-compose"
}

fetch_cwlmetrics_repo() {
  local url="https://github.com/inutano/cwl-metrics"
  echo "Installing cwlmetrics libraries at ${CWL_METRICS_DIR}..."
  git clone "${url}" "${CWL_METRICS_DIR}"
}

fetch_dmc_repo(){
  local url="https://github.com/inutano/docker-metrics-collector"
  local dmc_repo="${CWL_METRICS_DIR}/repos/dmc"
  echo "Installing docker metrics collector at ${dmc_repo}..."
  mkdir -p "${CWL_METRICS_DIR}/repos"
  git clone "${url}" "${dmc_repo}"
}

generate_config(){
  echo "Generating config file at ${CWL_METRICS_DIR}/config ..."
  cat  > "${CWL_METRICS_DIR}/config" <<-EOS
ES_HOST=${ES_HOST}
ES_PORT=${ES_PORT}
DMC_DIR_PATH=${HOME}/.cwlmetrics/repos/dmc
EOS
}

pull_containers(){
  echo "Pulling containers..."
  docker pull "yyabuki/docker-cwllog-generator:latest"
}

init_cwl_metrics() {
  if [[ -e "${CWL_METRICS_DIR}" ]]; then
    help
    exit 0
  else
    echo "Initializing CWL-metrics..."
    check_dependencies
    fetch_cwlmetrics_repo
    fetch_dmc_repo
    generate_config
    pull_containers
    echo "CWL-metrics initialization complete. Starting system..."
  fi
}

## Show CWL-metrics status
cwl_metrics_status() {
  pid_file="/tmp/cwllog_pid"
  if [[ -e "${pid_file}" ]]; then
    echo "cwl-metrics is running."
    exit 0
  else
    echo "cwl-metrics is not running."
    exit 1
  fi
}

## Start CWL-metrics processes and containers
es_endpoint() {
  host=$(cat ${CWL_METRICS_DIR}/config | awk -F'=' '/^ES_HOST/ { print $2 }')
  port=$(cat ${CWL_METRICS_DIR}/config | awk -F'=' '/^ES_PORT/ { print $2 }')
  if [[ -z ${host} ]]; then host=localhost; fi
  if [[ -z ${port} ]]; then port=9200; fi
  echo "http://${host}:${port}"
}

check_es_index() {
  echo "Creating Elasticsearch index..."
  local ep="$(es_endpoint)"
  while [[ -z $(curl -s "${ep}/workflow" | grep workflow_log) ]]; do
    sleep 1
  done
  echo $(curl -s "${ep}/telegraf")
  echo $(curl -s "${ep}/workflow")
}

start_cwl_metrics() {
  echo "Starting CWL-metrics..."
  perl "${CWL_METRICS_DIR}/lib/daemon/init.pl" start
  # Check setup container down and index of ES is available
  check_es_index
  echo -e "\nCWL-metrics is running."
}

## Stop CWL-metrics processes and containers
stop_cwl_metrics() {
  echo "Stopping CWL-metrics..."
  perl "${CWL_METRICS_DIR}/lib/daemon/init.pl" stop
  echo "CWL-metrics is stopped."
}

## List all metrics data of workflows and tools stored in ES
list_data() {
  echo "Fetching data..."
}

#
# Exec: init if no arguments metricsified, otherwise select command
#
if [[ $# -eq 0 ]]; then
  init_cwl_metrics
  start_cwl_metrics
else
  while [[ $# -gt 0 ]]; do
    key=${1}
    case ${key} in
      status)
        cwl_metrics_status
        ;;
      start)
        start_cwl_metrics
        ;;
      stop)
        stop_cwl_metrics
        ;;
      restart)
        stop_cwl_metrics
        start_cwl_metrics
        ;;
      list)
        list_data
        ;;
      -v|--version)
        version
        exit 0
        ;;
      *)
        help
        exit 0
        ;;
    esac
    shift
  done
fi
