#!/bin/bash
set -eux

#
# Variables
#
VERSION="2.0.0.20200528"
CWLTOOL_CONTAINER_IMAGE="commonworkflowlanguage/cwltool:1.0.20191225192155"
TELEGRAF_CONTAINER_IMAGE="telegraf:1.14.3"
ELASTICSEARCH_CONTAINER_IMAGE="elasticsearch:7.7.0"

#
# Functions
#
run_dmc_stack() {}
run_cwltool() {}
collect_metrics() {}
fetch_metrics() {}
show_status() {}

#
# Operation functions
#
up() {
  run_dmc_stack
}

down() {
  stop_dmc_stack
}

run() {
  run_dmc_stack
  run_cwltool
  collect_metrics
}

fetch() {
  run_dmc_stack
  fetch_metrics
}

status() {
  show_status
}

version() {
  printf "cwl-metrics: ${VERSION}\n"
  printf "  using cwltool container:  ${CWLTOOL_CONTAINER_IMAGE}\n"
  printf "        telegraf container: ${TELEGRAF_CONTAINER_IMAGE}\n"
  printf "        elasticsearch container: ${ELASTICSEARCH_CONTAINER_IMAGE}\n"
}

help() {
  cat <<EOS
cwl-metrics: ${VERSION}
Usage:
  cwl-metrics [up|down|run|fetch|status|help|version] <wf.cwl> <wf.conf>

Subcommand:
  up                      Start metrics collector containers
  down                    Stop metrics collector containers
  run                     Run given workflow via cwltool and collect metrics
  fetch                   Start Virtuoso and load data; add data to the existing
  status                  Show status of metrics collector containers
  help (-h|--help)        Show this help message
  version (-v|--version)  Show version information

Options:
  --es-port  Set Elasticsearch port number (default: 9200)
  --es-host  Set Elasticsearch host name (default: localhost)
  --tmpdir   Set tmpdir to process and store log files (default: /tmp/cwl-metrics)
EOS
}

#
# Main funciton
#
main() {
  POSITIONAL=()
  if [[ $# -eq 0 ]]; then
    help
    exit 0
  else
    while [[ $# -gt 0 ]]; do
      key=${1}
      case ${key} in
        version|-v|--version)
          version
          exit 0
          ;;
        help|-h|--help)
          help
          exit 0
          ;;
        --es-port)
          ES_PORT=${2}
          shift
          ;;
        --es-host)
          ES_HOST=${2}
          shift
          ;;
        --tmpdir)
          TMPDIR=${2}
          shift
          ;;
        up)
          CMD="up"
          ;;
        down)
          CMD="down"
          ;;
        run)
          CMD="run"
          ;;
        fetch)
          CMD="fetch"
          ;;
        test)
          CMD="test"
          ;;
        status)
          CMD="status"
          ;;
        *)
          POSITIONAL+=("$1")
          ;;
      esac
      shift
    done
  fi
  set -- "${POSITIONAL[@]}"

  case ${CMD} in
    "up")
      up
      ;;
    "down")
      down
      ;;
    "run")
      run ${@}
      ;;
    "fetch")
      fetch
      ;;
    "test")
      test
      ;;
    "status")
      status
      ;;
  esac
}

# invoke main funciton
if [[ "${BASH_SOURCE[0]}" -ef "$0" ]]; then
  main ${@}
fi
