#!/bin/bash
#
# cwl-spec
#   usage:
#     cwl-spec [start|stop|list] <options>
#
set -e

#
# Variables
#
VERSION="20180514"
CWLSPEC_DIR="${HOME}/.cwlspec"

#
# Load functions
#

## Version
version() {
  echo "cwl-spec version ${VERSION}"
}

## Help
help() {
  cat <<-HELP

cwl-spec version ${VERSION}
Usage: cwl-spec [command] [options...]
Commands:
  start    Run CWL-spec daemon and containers
  stop     Stop daemon and containers
  status   Show CWL-spec system status
  list     List spec data stored in Elasticsearch

HELP
}

## Install/Initialize CWL-spec
check_cmd() {
  cmd=${1}
  printf "Checking ${cmd}..."
  if [[ -e $(which ${cmd}) ]]; then
    echo "OK."
  else
    echo -e "\nERROR: ${cmd} not found."
    echo "Failed to init CWL-spec"
    exit 1
  fi
}

check_dependencies() {
  check_cmd "git"
  check_cmd "perl"
  check_cmd "docker"
  check_cmd "docker-compose"
}

fetch_cwlspec_repo() {
  local url="https://github.com/inutano/cwl-spec"
  echo "Installing cwlspec libraries at ${CWLSPEC_DIR}..."
  git clone "${url}" "${CWLSPEC_DIR}"
}

fetch_dmc_repo(){
  local url="https://github.com/inutano/docker-metrics-collector"
  local dmc_repo="${CWLSPEC_DIR}/repos/dmc"
  echo "Installing docker metrics collector at ${dmc_repo}..."
  mkdir -p "${CWLSPEC_DIR}/repos"
  git clone "${url}" "${dmc_repo}"
}

generate_config(){
  echo "Generating config file at ${CWLSPEC_DIR}/config ..."
  cat  > "${CWLSPEC_DIR}/config" <<-EOS
ES_HOST=${ES_HOST}
ES_PORT=${ES_PORT}
DMC_DIR_PATH=${HOME}/.cwlspec/repos/dmc
EOS
}

pull_containers(){
  echo "Pulling containers..."
  docker pull "yyabuki/docker-cwllog-generator:latest"
}

init_cwl_spec() {
  if [[ -e "${CWLSPEC_DIR}" ]]; then
    help
    exit 0
  else
    echo "Initializing CWL-spec..."
    check_dependencies
    fetch_cwlspec_repo
    fetch_dmc_repo
    generate_config
    pull_containers
    echo "CWL-spec initialization complete. Starting system..."
  fi
}

## Show CWL-spec status
cwl_spec_status() {
  pid_file="/tmp/cwllog_pid"
  if [[ -e "${pid_file}" ]]; then
    echo "cwl-spec is running."
    exit 0
  else
    echo "cwl-spec is not running."
    exit 1
  fi
}

## Start CWL-spec processes and containers
es_endpoint() {
  host=$(cat ${CWLSPEC_DIR}/config | awk -F'=' '/^ES_HOST/ { print $2 }')
  port=$(cat ${CWLSPEC_DIR}/config | awk -F'=' '/^ES_PORT/ { print $2 }')
  if [[ -z ${host} ]]; then host=localhost; fi
  if [[ -z ${port} ]]; then port=9200; fi
  echo "http://${host}:${port}"
}

check_es_index() {
  echo "Creating Elasticsearch index..."
  local ep="$(es_endpoint)"
  while [[ -z $(curl "${ep}/workflow" | grep workflow_log) ]]; do
    sleep 1
  done
  curl "${ep}/telegraf"
  curl "${ep}/workflow"
}

start_cwl_spec() {
  echo "Starting CWL-spec..."
  perl "${CWLSPEC_DIR}/bin/init.pl" start
  # Check setup container down and index of ES is available
  check_es_index
  echo "CWL-spec is running."
}

## Stop CWL-spec processes and containers
stop_cwl_spec() {
  echo "Stopping CWL-spec..."
  perl "${CWLSPEC_DIR}/bin/init.pl" stop
  echo "CWL-spec is stopped."
}

## List all spec data of workflows and tools stored in ES
list_data() {
  echo "Fetching data..."
}

#
# Exec: init if no arguments specified, otherwise select command
#
if [[ $# -eq 0 ]]; then
  init_cwl_spec
else
  while [[ $# -gt 0 ]]; do
    key=${1}
    case ${key} in
      status)
        cwl_spec_status
        ;;
      start)
        start_cwl_spec
        ;;
      stop)
        stop_cwl_spec
        ;;
      restart)
        stop_cwl_spec
        start_cwl_spec
        ;;
      list)
        list_data
        ;;
      -v|--version)
        version
        exit 0
        ;;
      *)
        help
        exit 0
        ;;
    esac
    shift
  done
fi
